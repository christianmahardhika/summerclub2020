<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>FMTY</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css"
      type="text/css"
    />
    <script 
    src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" 
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" 
    crossorigin="anonymous"></script>

    <style>
        body {
            padding:1%;
        }
        .separator {
            margin-top: 10px;
        }
    </style>

  </head>

  <body id="root">

    <div class="ui grid container">
        <div class="column centered sixteen wide">
            <h1>FMTY</h1>
            <h4>Once you post something here, it will be permanently saved</h4>
            <form class="ui form eight wide" autocomplete="off">
                <div class="ui primary field big input fluid">
                  <input type="text" name="from" placeholder="From (optional)">
                </div>
                <div class="ui primary field big input fluid">
                  <input type="text" name="to" placeholder="To">
                </div>
                <div class="ui primary field big input fluid">
                    <textarea name="message" rows="5" style="overflow:auto;resize:none" placeholder="Put your radically honest message here..."></textarea>
                </div>
                <button class="ui primary button">Submit</button>
              </form>

            <div class="ui divider"></div>

            <div id="feed">
              
            </div>

        </div>
      </div>
  </body>

  <script>
  $(function() {
      refetchMessages()
      console.log( "hana, dul, set!" )
      $("form").submit(function(event){
          event.preventDefault();
          var payload = objectifyForm( $( this ).serializeArray() );

          $.post("api/message/post", JSON.stringify(payload), function (data) {
            $("input[type=text], textarea").val("")
            refetchMessages()
          } );

      });

    });

    function refetchMessages() {
        $.get( "api/message/list", function( data ) {
          $("#feed").empty()
          $.each(data.result.reverse(), function(i, item) {
            if(!data.result[i].from) {
              data.result[i].from = "N.A."
            }
              $("#feed").append("<div class=\"ui centered card fluid\">" +
                "<div class=\"content\">" +
                "<h5 class=\"header\">From "+ data.result[i].from +" To " + data.result[i].to + "</h5>" +
                "<p>"+ data.result[i].message +"</p>" +
                "</div></div>"
                )
          });

        });
    }

    function objectifyForm(formArray) {
        var returnArray = {};
        for (var i = 0; i < formArray.length; i++){
            returnArray[formArray[i]['name']] = formArray[i]['value'];
        }
        return returnArray;
    }

  </script>
</html>
